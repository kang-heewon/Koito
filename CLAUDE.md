# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Koito is a ListenBrainz-compatible scrobbler for self-hosters. It consists of a Go backend API server and a React frontend client.

## Common Commands

### Development

```bash
# Start PostgreSQL database container
make postgres.run         # First time setup
make postgres.start       # Start existing container

# Run API server in debug mode
make api.debug

# Run client dev server (separate terminal)
make client.dev

# Run documentation dev server
make docs.dev
```

### Testing & Building

```bash
# Run Go tests
make api.test
# or directly:
go test ./... -timeout 60s

# Build everything (API + client)
make build

# Build API only
make api.build

# Build client only
make client.build
```

### Database

```bash
# Dump schema from running postgres
make postgres.schemadump

# Generate Go code from SQL queries
sqlc generate
```

## Architecture

### Backend (Go)

- **cmd/api/main.go**: Entry point, initializes engine
- **engine/**: HTTP server setup, routing (`routes.go`), and handlers
  - `handlers/`: HTTP request handlers for all API endpoints
  - `middleware/`: Authentication and request validation
- **internal/**: Core business logic
  - `repository/`: Database queries (generated by sqlc from `db/queries/`)
  - `catalog/`: Music catalog management
  - `importer/`: Data import from Maloja, ListenBrainz, LastFM, Spotify
  - `mbz/`: MusicBrainz API integration
  - `images/`: Image processing with bimg
  - `models/`: Domain models
  - `cfg/`: Configuration management
- **db/**: Database schema and queries
  - `migrations/`: Goose migration files
  - `queries/`: SQL queries for sqlc

### Frontend (React)

Located in `client/`, built with:
- React Router v7 (file-based routing)
- TanStack Query for data fetching
- Vanilla Extract + Tailwind CSS for styling
- Vite for bundling

```bash
# Client commands
cd client
yarn install
yarn dev        # Development server
yarn build      # Production build
yarn typecheck  # TypeScript check
```

### API Structure

- `/apis/web/v1/*`: Web client API endpoints
- `/apis/listenbrainz/1/*`: ListenBrainz-compatible API for scrobblers
- `/images/{size}/{filename}`: Image serving

### Configuration

Environment variables (see `docs/src/content/docs/reference/configuration.md`):
- `KOITO_DATABASE_URL`: PostgreSQL connection string
- `KOITO_ALLOWED_HOSTS`: Allowed host headers
- `KOITO_CONFIG_DIR`: Directory for config files
- `KOITO_LOG_LEVEL`: Logging level (debug, info, etc.)
